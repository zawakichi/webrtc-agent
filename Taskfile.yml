# Task runner configuration for WebRTC Agent
# https://taskfile.dev/

version: '3'

vars:
  DOCKER_COMPOSE_DEV: environment/docker/docker-compose.dev.yml
  DOCKER_COMPOSE_PROD: environment/docker/compose.yaml
  DOCKER_BAKE_FILE: environment/docker/docker-bake.hcl
  FRONTEND_DIR: src/frontend
  BACKEND_DIR: src/backend
  DOCS_DIR: doc

tasks:
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¹ã‚¯ - ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
  default:
    desc: "åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º"
    silent: true
    cmds:
      - task --list

  # é–‹ç™ºç’°å¢ƒç®¡ç†
  dev:
    desc: "é–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ï¼ˆå…¨ã‚µãƒ¼ãƒ“ã‚¹ï¼‰"
    dir: environment/docker
    cmds:
      - docker-compose -f docker-compose.dev.yml up -d
      - echo "é–‹ç™ºç’°å¢ƒãŒèµ·å‹•ã—ã¾ã—ãŸ"

  dev:logs:
    desc: "é–‹ç™ºç’°å¢ƒã®ãƒ­ã‚°ã‚’è¡¨ç¤º"
    dir: environment/docker
    cmds:
      - docker-compose -f docker-compose.dev.yml logs -f

  dev:stop:
    desc: "é–‹ç™ºç’°å¢ƒã‚’åœæ­¢"
    dir: environment/docker
    cmds:
      - docker-compose -f docker-compose.dev.yml down
      - echo "é–‹ç™ºç’°å¢ƒã‚’åœæ­¢ã—ã¾ã—ãŸ"

  dev:restart:
    desc: "é–‹ç™ºç’°å¢ƒã‚’å†èµ·å‹•"
    cmds:
      - task: dev:stop
      - task: dev

  dev:clean:
    desc: "é–‹ç™ºç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆãƒœãƒªãƒ¥ãƒ¼ãƒ å‰Šé™¤ï¼‰"
    dir: environment/docker
    cmds:
      - docker-compose -f docker-compose.dev.yml down -v
      - docker system prune -f
      - echo "é–‹ç™ºç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ"

  # å€‹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†
  frontend:
    desc: "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - bun run dev:frontend

  backend:
    desc: "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - air

  docs:
    desc: "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
    cmds:
      - echo "MkDocsãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­..."
      - echo "ã‚¢ã‚¯ã‚»ã‚¹ URL - http://localhost:9000/webrtc-agent/"
      - docker run --rm -v $(pwd)/doc:/docs/docs -v $(pwd)/mkdocs.yml:/docs/mkdocs.yml:ro -p 9000:8000 webrtc-agent-docs

  # ãƒ“ãƒ«ãƒ‰é–¢é€£
  build:
    desc: "å…¨ä½“ã‚’ãƒ“ãƒ«ãƒ‰"
    cmds:
      - task: build:frontend
      - task: build:backend

  build:frontend:
    desc: "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - bun run build

  build:backend:
    desc: "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - go build -o ../../dist/backend/webrtc-agent cmd/webrtc-agent/main.go

  build:docs:
    desc: "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒ“ãƒ«ãƒ‰"
    cmds:
      - echo "MkDocsãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
      - docker run --rm -v $(pwd)/doc:/docs/docs -v $(pwd)/mkdocs.yml:/docs/mkdocs.yml:ro -v $(pwd)/site:/docs/site webrtc-agent-docs mkdocs build

  # Dockeré–¢é€£
  docker:build:
    desc: "Docker Bakeã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰"
    cmds:
      - docker buildx bake -f {{.DOCKER_BAKE_FILE}}

  docker:build:dev:
    desc: "é–‹ç™ºç”¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰"
    cmds:
      - docker-compose -f {{.DOCKER_COMPOSE_DEV}} build

  docker:build:prod:
    desc: "æœ¬ç•ªç”¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰"
    cmds:
      - docker buildx bake -f {{.DOCKER_BAKE_FILE}} production

  # ãƒ†ã‚¹ãƒˆé–¢é€£
  test:
    desc: "å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
    cmds:
      - task: test:unit
      - task: test:integration

  test:unit:
    desc: "ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - bun run test:unit

  test:integration:
    desc: "çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - go test -v ./...

  test:e2e:
    desc: "E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
    cmds:
      - playwright test --config=tests/e2e/playwright.config.ts

  test:bdd:
    desc: "BDDãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
    cmds:
      - jest --config=tests/bdd/jest.config.js

  test:coverage:
    desc: "ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - bun run test:coverage

  # å“è³ªç®¡ç†
  lint:
    desc: "ã‚³ãƒ¼ãƒ‰ã®é™çš„è§£æã‚’å®Ÿè¡Œ"
    cmds:
      - task: lint:frontend
      - task: lint:backend

  lint:frontend:
    desc: "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®é™çš„è§£æã‚’å®Ÿè¡Œ"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - bun run lint

  lint:backend:
    desc: "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®é™çš„è§£æã‚’å®Ÿè¡Œ"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - golangci-lint run

  format:
    desc: "ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å®Ÿè¡Œ"
    cmds:
      - task: format:frontend
      - task: format:backend

  format:frontend:
    desc: "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - bun run format

  format:backend:
    desc: "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - go fmt ./...
      - goimports -w .

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£
  db:migrate:
    desc: "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - go run scripts/migrate.go

  db:seed:
    desc: "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚·ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - go run scripts/seed.go

  db:reset:
    desc: "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ"
    cmds:
      - task: db:migrate
      - task: db:seed

  db:setup:test:
    desc: "ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
    env:
      NODE_ENV: test
    cmds:
      - task: db:migrate
      - task: db:seed

  # ä¾å­˜é–¢ä¿‚ç®¡ç†
  deps:
    desc: "ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
    cmds:
      - task: deps:frontend
      - task: deps:backend

  deps:frontend:
    desc: "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - bun install --frozen-lockfile

  deps:backend:
    desc: "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - go mod download
      - go mod verify

  deps:update:
    desc: "ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°"
    cmds:
      - task: deps:update:frontend
      - task: deps:update:backend

  deps:update:frontend:
    desc: "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - bun update

  deps:update:backend:
    desc: "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - go get -u ./...
      - go mod tidy

  # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  clean:
    desc: "å…¨ä½“ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
    cmds:
      - task: clean:frontend
      - task: clean:backend
      - task: clean:docker

  clean:frontend:
    desc: "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - rm -rf dist node_modules

  clean:backend:
    desc: "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - rm -rf tmp
      - go clean -cache

  clean:docker:
    desc: "Dockerã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
    cmds:
      - docker system prune -f
      - docker volume prune -f

  # åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  setup:
    desc: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
    cmds:
      - echo "WebRTC Agent ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
      - task: env:check
      - task: deps
      - task: build
      - echo "ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
      

  # ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
  env:check:
    desc: "ç’°å¢ƒå¤‰æ•°è¨­å®šã‚’ç¢ºèª"
    dir: environment/docker
    cmds:
      - |
        if [ ! -f .env ]; then
          echo "âš ï¸  .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo "ğŸ“ .env.exampleã‹ã‚‰.envã‚’ä½œæˆã—ã¦ãã ã•ã„:"
          echo "   cp .env.example .env"
          echo "ğŸ”‘ APIã‚­ãƒ¼ãªã©ã®è¨­å®šã‚’æ›´æ–°ã—ã¦ãã ã•ã„"
          exit 1
        else
          echo "âœ… .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        fi

  env:copy:
    desc: ".env.exampleã‹ã‚‰.envã‚’ä½œæˆ"
    dir: environment/docker
    cmds:
      - cp .env.example .env
      - echo "âœ… .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
      - echo "ğŸ”‘ APIã‚­ãƒ¼ãªã©ã®è¨­å®šã‚’æ›´æ–°ã—ã¦ãã ã•ã„"

  # ãƒ˜ãƒ«ãƒ—ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±
  version:
    desc: "ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º"
    silent: true
    cmds:
      - echo "WebRTC Agent v0.1.0"
      - echo "Go version:" && go version
      - echo "Bun version:" && bun --version
      - echo "Docker version:" && docker --version

  health:
    desc: "ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"
    cmds:
      - echo "=== ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ ==="
      - echo "Docker:" && docker ps --format "table {{.Names}}\t{{.Status}}"
      - echo "\nã‚µãƒ¼ãƒ“ã‚¹ç¢ºèª:"